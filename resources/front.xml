<?xml version="1.0" encoding="UTF-8"?>
<project name="front">
    <env name="dev"
        mailto="geoffroy.aubry@twenga.com"
        withsymlinks="true"
        loadtwengaservers="true"
        basedir="/home/aai/deployment_test/www.twenga"
    >
        <property name="web_servers" value="aai@${SERVER_AAI}" />
        <property name="static_servers" value="aai@${SERVER_AAI}" />
        <call target="content" />
    </env>

    <env name="qa"
        mailto="geoffroy.aubry@twenga.com"
        withsymlinks="true"
        loadtwengaservers="true"
        basedir="/home/httpd-qa/www.twenga"
    >
        <property name="web_servers" value="${SERVER_QA_PHPWEB_ALL}" />
        <property name="static_servers" value="${SERVER_STATIC_WEB_ALL}" />
        <call target="content" />
    </env>

    <target name="content">
        <call target="web_content" />
        <call target="static_content" />
    </target>

    <target name="web_content">
        <externalproperty name="ref" description="Branch or tag to deploy" />
        <gitexport repository="git@git.twenga.com:b2c/web.git" ref="${REF}" destdir="${TMPDIR}" />
        <filltemplate
            srcfile="${TMPDIR}/inc/deploy_config-template.inc.php"
            destfile="${TMPDIR}/inc/deploy_config.inc.php" />
        <!-- <buildlanguage project="web" destdir="${TMPDIR}/languages" /> -->
        <cvsexport repository=":extssh:@fs1.twenga.com:/home/cvsroot" module="twengaweb/common"
            destdir="${TMPDIR}/twenga-common" />
        <link src="${TMPDIR}/html/shorturl/config_shorturl.php" target="../../../../config/www.twenga/config_shorturl.php" />
        <link src="${TMPDIR}/inc/config.php" target="../../../config/www.twenga/config.php" />
        <link src="${TMPDIR}/inc/config-local" target="../../../config/www.twenga/config-local" />
        <link src="${TMPDIR}/inc/config_tracker.php" target="../../../config/www.twenga/config_tracker.php" />
        <mkdir destdir="${TMPDIR}/v3/templates_c" mode="777" />
        <mkdir destdir="${TMPDIR}/v4/templates_c" mode="777" />
        <sync src="${TMPDIR}/" destdir="${WEB_SERVERS}:${BASEDIR}" exclude="v3/css v3/js v4/css v4/js" />
    </target>

    <target name="static_content">
        <preparestaticcontent />
        <sync src="prod@fs3:/home/prod/twenga_files/merchant_logos/"
            destdir="${TMPDIR}/img/sites"
            include="*.png"
            exclude="*" />
        <sync src="prod@fs3:/home/prod/twenga_files/brand_logos/"
            destdir="${TMPDIR}/img/brands"
            include="*.png"
            exclude="*" />
        <rename src="${TMPDIR}/v3" dest="${TMPDIR}/web" />
        <rename src="${TMPDIR}/v4" dest="${TMPDIR}/webv4" />
        <tplminify tpldir="${TMPDIR}/web/templates" cssparentdir="${TMPDIR}/web"
            jsparentdir="${TMPDIR}/web" destdir="${TMPDIR}" imgoutpath="/${EXECUTION_ID}/web" />
        <tplminify tpldir="${TMPDIR}/webv4/templates" cssparentdir="${TMPDIR}/webv4"
            jsparentdir="${TMPDIR}/webv4" destdir="${TMPDIR}" imgoutpath="/${EXECUTION_ID}/webv4" />
        <sync src="${TMPDIR}/" destdir="${STATIC_SERVERS}:${BASEDIR}_statics/${EXECUTION_ID}"
            exclude="/Front /html /inc /languages /twenga-common /web/templates /webv4/templates" />
    </target>
</project>
